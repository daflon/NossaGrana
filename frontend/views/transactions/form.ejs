<% 
const currentPage = 'transactions';
const title = transaction ? 'Editar Transação' : 'Nova Transação';
const isEdit = !!transaction;
%>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-<%= isEdit ? 'pencil' : 'plus' %>-circle text-primary me-2"></i>
            <%= title %>
        </h1>
        <p class="text-muted mb-0">
            <%= isEdit ? 'Edite os dados da transação' : 'Adicione uma nova receita ou despesa' %>
        </p>
    </div>
    <a href="/transactions" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Voltar
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-form-text me-2"></i>
                    Dados da Transação
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/transactions" id="transactionForm">
                    <% if (isEdit) { %>
                        <input type="hidden" name="_method" value="PUT">
                        <input type="hidden" name="id" value="<%= transaction.id %>">
                    <% } %>

                    <!-- Tipo de Transação -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">Tipo de Transação</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="type" id="income" value="income" 
                                       <%= (!transaction || transaction.type === 'income') ? 'checked' : '' %>>
                                <label class="btn btn-outline-success" for="income">
                                    <i class="bi bi-arrow-up-circle me-2"></i>
                                    Receita
                                </label>

                                <input type="radio" class="btn-check" name="type" id="expense" value="expense"
                                       <%= (transaction && transaction.type === 'expense') ? 'checked' : '' %>>
                                <label class="btn btn-outline-danger" for="expense">
                                    <i class="bi bi-arrow-down-circle me-2"></i>
                                    Despesa
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Valor -->
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label fw-bold">
                                <i class="bi bi-currency-dollar me-1"></i>
                                Valor
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       step="0.01" min="0.01" required
                                       value="<%= transaction ? transaction.amount : '' %>"
                                       placeholder="0,00">
                            </div>
                        </div>

                        <!-- Data -->
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label fw-bold">
                                <i class="bi bi-calendar3 me-1"></i>
                                Data
                            </label>
                            <input type="date" class="form-control" id="date" name="date" required
                                   value="<%= transaction ? transaction.date : new Date().toISOString().split('T')[0] %>">
                        </div>
                    </div>

                    <!-- Descrição -->
                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">
                            <i class="bi bi-text-left me-1"></i>
                            Descrição
                        </label>
                        <input type="text" class="form-control" id="description" name="description" 
                               required minlength="3" maxlength="200"
                               value="<%= transaction ? transaction.description : '' %>"
                               placeholder="Ex: Salário, Supermercado, Combustível...">
                        <div class="form-text">Mínimo 3 caracteres, máximo 200</div>
                    </div>

                    <!-- Categoria -->
                    <div class="mb-3">
                        <label for="category" class="form-label fw-bold">
                            <i class="bi bi-tag me-1"></i>
                            Categoria
                        </label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Selecione uma categoria</option>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.id %>" 
                                        <%= (transaction && transaction.category == cat.id) ? 'selected' : '' %>
                                        data-color="<%= cat.color %>">
                                    <%= cat.name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>

                    <!-- Tags (opcional) -->
                    <div class="mb-4">
                        <label for="tags" class="form-label fw-bold">
                            <i class="bi bi-tags me-1"></i>
                            Tags (opcional)
                        </label>
                        <input type="text" class="form-control" id="tags" name="tags" 
                               placeholder="Ex: trabalho, casa, urgente (separadas por vírgula)">
                        <div class="form-text">Separe múltiplas tags com vírgulas</div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex justify-content-between">
                        <a href="/transactions" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-<%= isEdit ? 'check' : 'plus' %>-circle me-2"></i>
                            <%= isEdit ? 'Atualizar' : 'Adicionar' %> Transação
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="card mt-4" id="previewCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-eye me-2"></i>
                    Pré-visualização
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px;" id="previewIcon">
                            <i class="bi bi-arrow-up-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="previewDescription">-</strong>
                                <br>
                                <small class="text-muted">
                                    <span id="previewCategory">-</span> • 
                                    <span id="previewDate">-</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <strong id="previewAmount" class="text-success">R$ 0,00</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Elementos do formulário
const form = document.getElementById('transactionForm');
const typeInputs = document.querySelectorAll('input[name="type"]');
const amountInput = document.getElementById('amount');
const descriptionInput = document.getElementById('description');
const categorySelect = document.getElementById('category');
const dateInput = document.getElementById('date');

// Elementos da pré-visualização
const previewCard = document.getElementById('previewCard');
const previewIcon = document.getElementById('previewIcon');
const previewDescription = document.getElementById('previewDescription');
const previewCategory = document.getElementById('previewCategory');
const previewDate = document.getElementById('previewDate');
const previewAmount = document.getElementById('previewAmount');

// Atualizar pré-visualização
function updatePreview() {
    const type = document.querySelector('input[name="type"]:checked')?.value;
    const amount = amountInput.value;
    const description = descriptionInput.value;
    const categoryOption = categorySelect.selectedOptions[0];
    const date = dateInput.value;

    if (description && amount && type) {
        previewCard.style.display = 'block';
        
        // Ícone e cor
        const isIncome = type === 'income';
        const iconClass = isIncome ? 'bi-arrow-up-circle-fill text-success' : 'bi-arrow-down-circle-fill text-danger';
        const bgColor = isIncome ? '#27ae6020' : '#e74c3c20';
        
        previewIcon.innerHTML = `<i class="${iconClass}" style="font-size: 1.5rem;"></i>`;
        previewIcon.style.backgroundColor = bgColor;
        
        // Conteúdo
        previewDescription.textContent = description;
        previewCategory.textContent = categoryOption?.text || '-';
        previewDate.textContent = date ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
        
        // Valor
        const formattedAmount = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(amount || 0);
        
        previewAmount.textContent = (isIncome ? '+' : '-') + formattedAmount;
        previewAmount.className = isIncome ? 'text-success' : 'text-danger';
    } else {
        previewCard.style.display = 'none';
    }
}

// Event listeners
typeInputs.forEach(input => input.addEventListener('change', updatePreview));
amountInput.addEventListener('input', updatePreview);
descriptionInput.addEventListener('input', updatePreview);
categorySelect.addEventListener('change', updatePreview);
dateInput.addEventListener('change', updatePreview);

// Validação do formulário
form.addEventListener('submit', function(e) {
    const amount = parseFloat(amountInput.value);
    if (amount <= 0) {
        e.preventDefault();
        alert('O valor deve ser maior que zero.');
        amountInput.focus();
        return;
    }

    const description = descriptionInput.value.trim();
    if (description.length < 3) {
        e.preventDefault();
        alert('A descrição deve ter pelo menos 3 caracteres.');
        descriptionInput.focus();
        return;
    }

    // Adicionar loading ao botão
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
    submitBtn.disabled = true;
});

// Inicializar pré-visualização
updatePreview();

// Auto-focus no primeiro campo vazio
if (!descriptionInput.value) {
    descriptionInput.focus();
} else if (!amountInput.value) {
    amountInput.focus();
}
</script>

<% 
// Incluir o layout
const body = `
<div class="container-fluid">
    ${arguments[0]}
</div>
`;
%>

<%- include('../layout', { 
    title, 
    currentPage, 
    user, 
    body: body,
    success: typeof success !== 'undefined' ? success : null,
    error: typeof error !== 'undefined' ? error : null
}) %>