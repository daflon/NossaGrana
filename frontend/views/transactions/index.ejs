<% 
const currentPage = 'transactions';
const title = 'Transações';
%>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-arrow-left-right text-primary me-2"></i>
            Transações
        </h1>
        <p class="text-muted mb-0">Gerencie suas receitas e despesas</p>
    </div>
    <a href="/transactions/new" class="btn btn-primary">
        <i class="bi bi-plus me-2"></i>
        Nova Transação
    </a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/transactions" class="row g-3">
            <div class="col-md-4">
                <label for="type" class="form-label">Tipo</label>
                <select class="form-select" id="type" name="type">
                    <option value="">Todos</option>
                    <option value="income" <%= filters.type === 'income' ? 'selected' : '' %>>Receitas</option>
                    <option value="expense" <%= filters.type === 'expense' ? 'selected' : '' %>>Despesas</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="category" class="form-label">Categoria</label>
                <select class="form-select" id="category" name="category">
                    <option value="">Todas</option>
                    <% categories.forEach(cat => { %>
                        <option value="<%= cat.id %>" <%= filters.category == cat.id ? 'selected' : '' %>>
                            <%= cat.name %>
                        </option>
                    <% }); %>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary me-2">
                    <i class="bi bi-funnel me-1"></i>
                    Filtrar
                </button>
                <a href="/transactions" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i>
                    Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Transactions List -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>
            Lista de Transações
        </h5>
    </div>
    <div class="card-body">
        <% if (transactions && transactions.length > 0) { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th class="text-end">Valor</th>
                            <th width="100">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% transactions.forEach(transaction => { %>
                            <tr class="transaction-row">
                                <td>
                                    <span class="text-muted">
                                        <%= new Date(transaction.date).toLocaleDateString('pt-BR') %>
                                    </span>
                                </td>
                                <td>
                                    <strong><%= transaction.description %></strong>
                                    <% if (transaction.tags && transaction.tags.length > 0) { %>
                                        <br>
                                        <% transaction.tags.forEach(tag => { %>
                                            <span class="badge bg-secondary me-1"><%= tag.name %></span>
                                        <% }); %>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle me-2" 
                                             style="width: 12px; height: 12px; background-color: <%= transaction.category_color || '#6c757d' %>;"></div>
                                        <%= transaction.category_name %>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-<%= transaction.type === 'income' ? 'success' : 'danger' %>">
                                        <i class="bi bi-<%= transaction.type === 'income' ? 'arrow-up' : 'arrow-down' %>-circle me-1"></i>
                                        <%= transaction.type === 'income' ? 'Receita' : 'Despesa' %>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <strong class="<%= transaction.type === 'income' ? 'text-success' : 'text-danger' %>">
                                        <%= transaction.type === 'income' ? '+' : '-' %>
                                        <%= new Intl.NumberFormat('pt-BR', { 
                                            style: 'currency', 
                                            currency: 'BRL' 
                                        }).format(transaction.amount) %>
                                    </strong>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" title="Excluir" 
                                                onclick="confirmDelete(<%= transaction.id %>, '<%= transaction.description %>')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <% if (pagination && pagination.count > 10) { %>
                <nav aria-label="Paginação de transações" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <% if (pagination.previous) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= pagination.currentPage - 1 %><%= filters.type ? '&type=' + filters.type : '' %><%= filters.category ? '&category=' + filters.category : '' %>">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        <% } %>
                        
                        <% 
                        const totalPages = Math.ceil(pagination.count / 10);
                        const currentPage = pagination.currentPage;
                        const startPage = Math.max(1, currentPage - 2);
                        const endPage = Math.min(totalPages, currentPage + 2);
                        %>
                        
                        <% for (let i = startPage; i <= endPage; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %><%= filters.type ? '&type=' + filters.type : '' %><%= filters.category ? '&category=' + filters.category : '' %>">
                                    <%= i %>
                                </a>
                            </li>
                        <% } %>
                        
                        <% if (pagination.next) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= pagination.currentPage + 1 %><%= filters.type ? '&type=' + filters.type : '' %><%= filters.category ? '&category=' + filters.category : '' %>">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>
        <% } else { %>
            <div class="text-center py-5">
                <i class="bi bi-receipt text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">Nenhuma transação encontrada</h4>
                <p class="text-muted">Comece adicionando sua primeira transação</p>
                <a href="/transactions/new" class="btn btn-primary">
                    <i class="bi bi-plus me-2"></i>
                    Adicionar Transação
                </a>
            </div>
        <% } %>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a transação <strong id="transactionName"></strong>?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>
</div>

<script>
let transactionToDelete = null;

function confirmDelete(id, description) {
    transactionToDelete = id;
    document.getElementById('transactionName').textContent = description;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (transactionToDelete) {
        // Aqui você implementaria a exclusão via AJAX
        // Por enquanto, vamos apenas fechar o modal
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        
        // Simular exclusão bem-sucedida
        setTimeout(() => {
            location.reload();
        }, 500);
    }
});
</script>

<% 
// Incluir o layout
const body = `
<div class="container-fluid">
    ${arguments[0]}
</div>
`;
%>

<%- include('../layout', { 
    title, 
    currentPage, 
    user, 
    body: body,
    success: typeof success !== 'undefined' ? success : null,
    error: typeof error !== 'undefined' ? error : null
}) %>